<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lagerprototyp</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#222222">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    body { font-family: system-ui, sans-serif; margin:0; padding:1rem; background:#f5f5f5; color:#222; }
    header { margin-bottom: 1rem; }
    h1 { font-size:1.2rem; margin:0 0 .5rem 0; }
    .card { background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.07); padding:1rem; margin-bottom:1rem; }
    label { font-size:.9rem; font-weight:600; display:block; margin-bottom:.25rem; }
    select, input, textarea, button { width:100%; font-size:1rem; padding:.7rem .8rem; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; margin-bottom:.75rem; background:#fff; }
    button { background:#222; color:#fff; font-weight:600; border:none; cursor:pointer; }
    .row { display:flex; gap:.75rem; flex-wrap:wrap; }
    .row > div { flex:1 1 140px; }
    .results { font-size:.9rem; line-height:1.4; }
    .result-item { background:#fff; border-radius:8px; border:1px solid #ddd; padding:.75rem; margin-bottom:.5rem; }
    .result-item strong { display:block; font-size:.95rem; }
    .muted { color:#666; font-size:.8rem; }
    .ok { color:#0a7f2e; }
    .err { color:#b00020; }
  </style>
</head>
<body>

<header>
  <h1>Lagervy (demo)</h1>
  <div class="muted">1) Skapa pall ‚Üí 2) Tilldela plats ‚Üí 3) S√∂k/visa ‚Üí 4) Snabbflytt (beta)</div>
</header>

<!-- 1. Skapa pall -->
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">1. Skapa pall</h2>
  <label for="createPallIdInput">Pall-ID</label>
  <input id="createPallIdInput" type="text" placeholder="t.ex. P014" />
  <label for="createContentsInput">Vad finns i pallen?</label>
  <textarea id="createContentsInput" rows="3" placeholder="Rillmugg vit, Alma stol bl√•..."></textarea>
  <label for="createWhoInput">Packad av</label>
  <input id="createWhoInput" type="text" placeholder="t.ex. Aleksandra" />
  <button id="createSaveBtn">Spara pall</button>
  <div id="createSaveMsg" class="muted"></div>
</section>

<!-- 2. Tilldela pall till plats -->
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">2. Tilldela pall till plats</h2>
  <div class="row">
    <div>
      <label for="assignPallIdInput">Pall-ID</label>
      <input id="assignPallIdInput" type="text" placeholder="t.ex. P014" />
    </div>
    <div>
      <label for="assignPlaceSelect">Plats</label>
      <select id="assignPlaceSelect"></select>
    </div>
  </div>
  <label for="assignWhoInput">Ink√∂rd av</label>
  <input id="assignWhoInput" type="text" placeholder="t.ex. Yosef" />
  <button id="assignSaveBtn">Spara placering</button>
  <div id="assignSaveMsg" class="muted"></div>
</section>

<!-- 3. Visa vad som st√•r p√• en plats -->
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">3. Visa inneh√•ll p√• plats</h2>
  <div class="row">
    <div>
      <label for="inspectSelect">Plats</label>
      <select id="inspectSelect"></select>
    </div>
  </div>
  <button id="inspectBtn">Visa inneh√•ll</button>
  <div id="inspectResult" class="results"></div>
</section>

<!-- 4. S√∂k efter artikel och f√• plats -->
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">4. S√∂k artikel ‚Üí hitta plats</h2>
  <input id="searchInput" type="text" placeholder="Ex: Rillmugg / Alma stol" />
  <button id="searchBtn">S√∂k var den st√•r</button>
  <div id="searchResults" class="results"></div>
</section>

<!-- 5. Snabbflytt (beta) ‚Äî notera: ingen JS √§nnu i Firebase-versionen -->
<!-- 5. Snabbflytt (beta) ‚Äî notera: ingen JS √§nnu i Firebase-versionen -->
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">5. Snabbflytt (beta)</h2>
  <div class="row">
    <div>
      <label for="moveFromSelect">Fr√•n plats</label>
      <select id="moveFromSelect"></select>
    </div>
    <div>
      <label for="moveToSelect">Till plats</label>
      <select id="moveToSelect"></select>
    </div>
  </div>
  <label for="moveWhoInput">Flyttad av</label>
  <input id="moveWhoInput" type="text" placeholder="t.ex. Yosef" />


  <div id="moveMsg" class="muted"></div>
</section>

<!-- 6. Export/Import ‚Äî notera: ingen JS √§nnu i Firebase-versionen -->
 
<section class="card">
  <h2 style="font-size:1rem;margin-top:0;">Export/Import</h2>

  <button id="exportBtn">Exportera data (JSON)</button>

  <label for="importInput">Importera data (JSON-fil)</label>
  <input id="importInput" type="file" accept="application/json" />

  <div class="muted">Export/Import h√§mtar & √•terst√§ller lagret.</div>

  <button id="exportBtn">Exportera data (JSON)</button>

  <label for="importInput">Importera data (JSON-fil)</label>
  <input id="importInput" type="file" accept="application/json" />

  <div class="muted">Export/Import h√§mtar & √•terst√§ller lagret.</div>
</section>

<!-- ===== Firebase + App-logik ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, enableIndexedDbPersistence,
    doc, getDoc, setDoc, getDocs, collection, onSnapshot, writeBatch, runTransaction
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  
  // === Firebase Setup ===
  const firebaseConfig = {
    apiKey: "AIzaSyC_lEAQE6m-LhuxWfbWVlZ7ag_RQHB_ZbQ",
    authDomain: "lagervy---databas.firebaseapp.com",
    projectId: "lagervy---databas",
    storageBucket: "lagervy---databas.firebasestorage.app",
    messagingSenderId: "389445759047",
    appId: "1:389445759047:web:4ec5c41980d6f7939a4162",
    measurementId: "G-MLL7N1SDBB"
  };
  
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  await signInAnonymously(auth).catch(console.error);
  enableIndexedDbPersistence(db).catch(() => {});
  
  // === DOM-referenser ===
  const moveWhoInput      = document.getElementById("moveWhoInput");
  const moveBtn           = document.getElementById("moveBtn");
  const clearFromBtn      = document.getElementById("clearFromBtn");
  const moveMsg           = document.getElementById("moveMsg");
  const createPallIdInput = document.getElementById("createPallIdInput");
  const createContentsInput = document.getElementById("createContentsInput");
  const createWhoInput    = document.getElementById("createWhoInput");
  const createSaveBtn     = document.getElementById("createSaveBtn");
  const createSaveMsg     = document.getElementById("createSaveMsg");
  const assignPallIdInput = document.getElementById("assignPallIdInput");
  const assignWhoInput    = document.getElementById("assignWhoInput");
  const assignSaveBtn     = document.getElementById("assignSaveBtn");
  const assignSaveMsg     = document.getElementById("assignSaveMsg");
  const inspectBtn        = document.getElementById("inspectBtn");
  const inspectResult     = document.getElementById("inspectResult");
  const searchBtn         = document.getElementById("searchBtn");
  const searchInput       = document.getElementById("searchInput");
  const searchResults     = document.getElementById("searchResults");
  const exportBtn         = document.getElementById("exportBtn");
  const importInput       = document.getElementById("importInput");

// Skapa platser
const places = [];
(function gen() {
  const S = ["L", "R"];
  for (const side of S)
    for (let r = 1; r <= 4; r++)
      for (let c = 1; c <= 3; c++)
        for (let h = 1; h <= 3; h++)
          places.push(`${side}-R${r}-C${c}-H${h}`);
})();

// H√§mta dropdowns fr√•n DOM
const assignPlaceSelect = document.getElementById("assignPlaceSelect");
const inspectSelect     = document.getElementById("inspectSelect");
const moveFromSelect    = document.getElementById("moveFromSelect");
const moveToSelect      = document.getElementById("moveToSelect");

// Definiera funktionen
function fillSelect(el, arr) {
  if (!el) return;
  el.innerHTML = "";
  arr.forEach(v => {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    el.appendChild(o);
  });
}

  // === Realtidsuppdatering ===
  onSnapshot(collection(db, "pallets"), (snap) => {
    snap.docChanges().forEach(ch => {
      if (ch.type === "removed") delete pallets[ch.doc.id];
      else pallets[ch.doc.id] = ch.doc.data();
    });
  });
  onSnapshot(collection(db, "locations"), (snap) => {
    snap.docChanges().forEach(ch => {
      if (ch.type === "removed") delete locations[ch.doc.id];
      else locations[ch.doc.id] = ch.doc.data();
    });
    refreshPlaceOptionLabels();
  });
  
// Fyll dropdowns
fillSelect(assignPlaceSelect, places);
fillSelect(inspectSelect, places);
fillSelect(moveFromSelect, places);
fillSelect(moveToSelect, places);

  // === Uppdatera dropdowns ===
  function refreshPlaceOptionLabels() {
    const label = (pid) => {
      const loc = locations[pid];
      const suffix = (loc && loc.pallId) ? `‚Äî ${loc.pallId}` : "‚Äî (ledig)";
      return `${pid} ${suffix}`;
    };
    const rebuild = (selectEl) => {
      if (!selectEl) return;
      const current = selectEl.value;
      selectEl.innerHTML = "";
      places.forEach(pid => {
        const o = document.createElement("option");
        o.value = pid;
        o.textContent = label(pid);
        selectEl.appendChild(o);
      });
      if (current) selectEl.value = current;
    };
    rebuild(assignPlaceSelect);
    rebuild(inspectSelect);
    rebuild(moveFromSelect);
    rebuild(moveToSelect);
  }
  
  // === Funktioner ===
  
  // 1. Skapa ny pall
  createSaveBtn?.addEventListener("click", async () => {
    setMsg(createSaveMsg, "");
    const id = createPallIdInput.value.trim();
    const contents = createContentsInput.value.trim();
    const who = createWhoInput.value.trim();
    if (!id) return setMsg(createSaveMsg, "‚ùå Du m√•ste ange Pall-ID.", "muted err");
    if (!contents) return setMsg(createSaveMsg, "‚ùå Du m√•ste ange inneh√•ll.", "muted err");
    const ref = doc(db, "pallets", id);
    if ((await getDoc(ref)).exists()) return setMsg(createSaveMsg, "‚ùå Pall-ID finns redan.", "muted err");
    await setDoc(ref, { contents, who, createdDate: today() });
    setMsg(createSaveMsg, `‚úÖ Pall ${id} skapad.`, "ok");
  });
  
  // 2. Tilldela pall till plats
  assignSaveBtn?.addEventListener("click", async () => {
    setMsg(assignSaveMsg, "");
    const pallId = assignPallIdInput.value.trim();
    const placeId = assignPlaceSelect.value;
    const who = assignWhoInput.value.trim();
    if (!pallId) return setMsg(assignSaveMsg, "‚ùå Du m√•ste ange Pall-ID.", "muted err");
    const pSnap = await getDoc(doc(db, "pallets", pallId));
    if (!pSnap.exists()) return setMsg(assignSaveMsg, "‚ùå Det Pall-ID:t finns inte. Skapa pallen f√∂rst.", "muted err");
    const old = await getDoc(doc(db, "locations", placeId));
    const replaced = old.exists() && old.data().pallId ? ` (ersatte ${old.data().pallId})` : "";
    await setDoc(doc(db, "locations", placeId), { pallId, who, updated: today() });
    setMsg(assignSaveMsg, `‚úÖ Plats ${placeId} har nu pall ${pallId}.${replaced}`, "ok");
  });
  
  // 3. Flytta pall
  moveBtn?.addEventListener("click", async () => {
    setMsg(moveMsg, "");
    const fromId = moveFromSelect?.value;
    const toId = moveToSelect?.value;
    const who = moveWhoInput?.value.trim();
    if (!fromId || !toId) return setMsg(moveMsg, "‚ùå V√§lj b√•de 'Fr√•n' och 'Till'.", "muted err");
    if (fromId === toId) return setMsg(moveMsg, "‚ùå Samma plats.", "muted err");
    try {
      await runTransaction(db, async (tx) => {
        const fromRef = doc(db, "locations", fromId);
        const toRef = doc(db, "locations", toId);
        const fromSnap = await tx.get(fromRef);
        const toSnap = await tx.get(toRef);
        const fromData = fromSnap.data() || {};
        const toData = toSnap.data() || {};
        if (!fromData.pallId) throw new Error(`Ingen pall p√• ${fromId}.`);
        if (toData.pallId) throw new Error(`Till-platsen ${toId} √§r upptagen (${toData.pallId}).`);
        tx.set(fromRef, { pallId: "", who: who || fromData.who || "", updated: today() });
        tx.set(toRef, { pallId: fromData.pallId, who: who || toData.who || "", updated: today() });
      });
      setMsg(moveMsg, `‚úÖ Flytt klar: ${fromId} ‚Üí ${toId}`, "ok");
    } catch (e) {
      setMsg(moveMsg, `‚ùå ${e.message}`, "muted err");
    }
  });
  
  // 4. T√∂m fr√•n-plats
  clearFromBtn?.addEventListener("click", async () => {
    setMsg(moveMsg, "");
    const fromId = moveFromSelect?.value;
    const who = moveWhoInput?.value.trim();
    if (!fromId) return setMsg(moveMsg, "‚ùå V√§lj 'Fr√•n'-plats.", "muted err");
    const ref = doc(db, "locations", fromId);
    const snap = await getDoc(ref);
    const had = snap.exists() && snap.data().pallId;
    await setDoc(ref, { pallId: "", who: who || (snap.data()?.who || ""), updated: today() });
    setMsg(moveMsg, had ? `üßπ T√∂mde ${fromId}.` : `‚ÑπÔ∏è ${fromId} var redan tom.`, "muted");
  });
  
  // 5. Inspektera plats
  inspectBtn?.addEventListener("click", async () => {
    const placeId = inspectSelect.value;
    const loc = locations[placeId];
    if (!loc || !loc.pallId) {
      inspectResult.innerHTML = `<div class="result-item"><strong>${placeId}</strong><div class="muted">Ingen pall registrerad h√§r.</div></div>`;
      return;
    }
    const p = pallets[loc.pallId] || {};
    inspectResult.innerHTML = `
      <div class="result-item">
        <strong>${placeId}</strong>
        <div>Pall-ID: ${loc.pallId}</div>
        <div>Inneh√•ll: ${p.contents || "-"}</div>
        <div class="muted">
          Packad av ${p.who || "ok√§nd"} ${p.createdDate ? "den " + p.createdDate : ""}<br/>
          Ink√∂rd av ${loc.who || "ok√§nd"} ${loc.updated ? "den " + loc.updated : ""}
        </div>
      </div>`;
  });
  
  // 6. S√∂k
  searchBtn?.addEventListener("click", () => {
    const q = (searchInput.value || "").trim().toLowerCase();
    if (!q) { searchResults.innerHTML = `<div class="muted">Skriv n√•got att s√∂ka p√•.</div>`; return; }
  
    const matching = Object.entries(pallets)
      .filter(([id, info]) => (info?.contents || "").toLowerCase().includes(q))
      .map(([id]) => id);
  
    const hits = [];
    for (const [placeId, loc] of Object.entries(locations)) {
      if (matching.includes(loc.pallId)) {
        const p = pallets[loc.pallId] || {};
        hits.push({ placeId, pallId: loc.pallId, contents: p.contents, packedBy: p.who, packedDate: p.createdDate, storedBy: loc.who, storedDate: loc.updated });
      }
    }
  
    if (!hits.length) {
      searchResults.innerHTML = `<div class="muted">Inget hittades f√∂r "${q}".</div>`;
      return;
    }
  
    searchResults.innerHTML = hits.map(h => `
      <div class="result-item">
        <strong>${h.placeId}</strong>
        <div>Pall-ID: ${h.pallId}</div>
        <div>Inneh√•ll: ${h.contents}</div>
        <div class="muted">
          Packad av ${h.packedBy || "ok√§nd"} ${h.packedDate ? "den " + h.packedDate : ""}<br/>
          Ink√∂rd av ${h.storedBy || "ok√§nd"} ${h.storedDate ? "den " + h.storedDate : ""}
        </div>
      </div>`).join("");
  });
  
  // 7. Exportera data
  exportBtn?.removeAttribute("disabled");
  exportBtn?.addEventListener("click", async () => {
    setMsg(moveMsg, "");
    try {
      const [palSnap, locSnap] = await Promise.all([
        getDocs(collection(db, "pallets")),
        getDocs(collection(db, "locations"))
      ]);
      const palletsOut = {};
      palSnap.forEach(d => palletsOut[d.id] = d.data());
      const locationsOut = {};
      locSnap.forEach(d => locationsOut[d.id] = d.data());
      const payload = { exportedAt: new Date().toISOString(), pallets: palletsOut, locations: locationsOut };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `lagerapp-backup-${today()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      setMsg(moveMsg, `‚ùå Export misslyckades: ${e.message}`, "muted err");
    }
  });
  
  // 8. Importera data
  importInput?.removeAttribute("disabled");
  importInput?.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setMsg(moveMsg, "‚è≥ Importerar‚Ä¶");
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      const palletsIn = data.pallets || {};
      const locationsIn = data.locations || {};
      const chunks = [];
      const writes = [];
  
      for (const [id, val] of Object.entries(palletsIn)) writes.push({ col: "pallets", id, val });
      for (const [id, val] of Object.entries(locationsIn)) writes.push({ col: "locations", id, val });
  
      const BATCH_LIMIT = 400;
      for (let i = 0; i < writes.length; i += BATCH_LIMIT) {
        chunks.push(writes.slice(i, i + BATCH_LIMIT));
      }
  
      for (const chunk of chunks) {
        const batch = writeBatch(db);
        chunk.forEach(w => batch.set(doc(db, w.col, w.id), w.val));
        await batch.commit();
      }
  
      setMsg(moveMsg, `‚úÖ Import klar: ${Object.keys(palletsIn).length} pallar, ${Object.keys(locationsIn).length} platser.`, "ok");
      e.target.value = ""; // nollst√§ll input
    } catch (err) {
      setMsg(moveMsg, `‚ùå Import misslyckades: ${err.message}`, "muted err");
    }
  });
  </script>
  

<!-- ===== Service Worker (en g√•ng, med uppdateringsfl√∂de) ===== -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').then(reg => {
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && navigator.serviceWorker.controller) {
              const ok = confirm('Ny version av appen finns. Uppdatera nu?');
              if (ok) sw.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    });
  }
</script>

</body>
</html>